{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "workflow-yaml.schema.json",
  "title": "Workflow YAML Schema",
  "description": "JSON Schema for validating workflow YAML definitions",
  "type": "object",
  "required": ["workflow_name", "version", "steps"],
  "additionalProperties": false,
  "properties": {
    "workflow_name": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9._]*$",
      "description": "Unique workflow identifier (lowercase, dots/underscores allowed)"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+(-[a-zA-Z0-9.]+)?(\\+[a-zA-Z0-9.]+)?$",
      "description": "Semantic version (e.g., 1.0.0, 1.0.0-beta.1)"
    },
    "description": {
      "type": "string",
      "description": "Human-readable description of the workflow"
    },
    "steps": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/workflowStep" },
      "description": "Ordered list of workflow steps"
    }
  },
  "$defs": {
    "workflowStep": {
      "type": "object",
      "required": ["step_id", "skill_id", "depends_on", "input_selector"],
      "additionalProperties": false,
      "properties": {
        "step_id": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_]*$",
          "description": "Unique step identifier within workflow"
        },
        "skill_id": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_]*$",
          "description": "Reference to skill in catalog"
        },
        "depends_on": {
          "type": "array",
          "items": { "type": "string", "pattern": "^[a-z][a-z0-9_]*$" },
          "description": "Step IDs this step depends on"
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of the step"
        },
        "input_selector": {
          "$ref": "#/$defs/inputSelector",
          "description": "Declarative input mapping configuration"
        },
        "cache_policy": {
          "$ref": "#/$defs/cachePolicy"
        },
        "retry_policy": {
          "$ref": "#/$defs/retryPolicy"
        }
      }
    },
    "inputSelector": {
      "type": "object",
      "additionalProperties": { "$ref": "#/$defs/inputSelectorField" },
      "description": "Map of output field names to selector configurations"
    },
    "inputSelectorField": {
      "oneOf": [
        { "$ref": "#/$defs/triggerSourceSelector" },
        { "$ref": "#/$defs/stepOutputSourceSelector" },
        { "$ref": "#/$defs/baseRunSourceSelector" },
        { "$ref": "#/$defs/registrySourceSelector" },
        { "$ref": "#/$defs/constantsSourceSelector" },
        { "$ref": "#/$defs/mergeOperationSelector" },
        { "$ref": "#/$defs/pickOperationSelector" }
      ]
    },
    "triggerSourceSelector": {
      "type": "object",
      "required": ["source", "path"],
      "additionalProperties": false,
      "properties": {
        "source": { "const": "trigger" },
        "path": {
          "type": "string",
          "description": "JSONPath-like path into trigger payload"
        }
      }
    },
    "stepOutputSourceSelector": {
      "type": "object",
      "required": ["source", "step_id", "path"],
      "additionalProperties": false,
      "properties": {
        "source": { "const": "step_output" },
        "step_id": {
          "type": "string",
          "description": "ID of the step to get output from"
        },
        "path": {
          "type": "string",
          "description": "JSONPath-like path into step output"
        }
      }
    },
    "baseRunSourceSelector": {
      "type": "object",
      "required": ["source", "step_id", "path"],
      "additionalProperties": false,
      "properties": {
        "source": { "const": "base_run" },
        "step_id": {
          "type": "string",
          "description": "ID of the step from base run"
        },
        "path": {
          "type": "string",
          "description": "JSONPath-like path into base run step output"
        }
      }
    },
    "registrySourceSelector": {
      "type": "object",
      "required": ["source", "type", "id"],
      "additionalProperties": false,
      "properties": {
        "source": { "const": "registry" },
        "type": {
          "type": "string",
          "enum": ["prompt", "config", "rubric"]
        },
        "id": {
          "type": "string",
          "description": "Registry item identifier"
        },
        "version": {
          "type": "string",
          "description": "Optional version, defaults to latest"
        }
      }
    },
    "constantsSourceSelector": {
      "type": "object",
      "required": ["source", "value"],
      "additionalProperties": false,
      "properties": {
        "source": { "const": "constants" },
        "value": {
          "description": "Any JSON-serializable constant value"
        }
      }
    },
    "mergeOperationSelector": {
      "type": "object",
      "required": ["operation", "inputs"],
      "additionalProperties": false,
      "properties": {
        "operation": { "const": "merge" },
        "inputs": {
          "type": "array",
          "minItems": 2,
          "items": { "$ref": "#/$defs/inputSelectorField" },
          "description": "Array of selectors to merge"
        }
      }
    },
    "pickOperationSelector": {
      "type": "object",
      "required": ["operation", "input", "keys"],
      "additionalProperties": false,
      "properties": {
        "operation": { "const": "pick" },
        "input": {
          "$ref": "#/$defs/inputSelectorField",
          "description": "Selector to pick keys from"
        },
        "keys": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string" },
          "description": "Keys to pick from the input object"
        }
      }
    },
    "cachePolicy": {
      "type": "object",
      "required": ["enabled", "scope"],
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Whether caching is enabled for this step"
        },
        "scope": {
          "type": "string",
          "enum": ["global", "run_only"],
          "description": "Cache scope: global (cross-run) or run_only (single run)"
        }
      }
    },
    "retryPolicy": {
      "type": "object",
      "required": ["max_attempts", "backoff_ms"],
      "additionalProperties": false,
      "properties": {
        "max_attempts": {
          "type": "integer",
          "minimum": 1,
          "maximum": 10,
          "description": "Maximum number of retry attempts"
        },
        "backoff_ms": {
          "type": "integer",
          "minimum": 100,
          "maximum": 60000,
          "description": "Backoff delay between retries in milliseconds"
        }
      }
    }
  }
}
