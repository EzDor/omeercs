# Scratch Card Game Template

## Purpose
A full 3D scratch card rendered in Three.js with realistic metallic scratch layer, shader-based reveal effects, and particle debris. Users scratch the 3D card surface to reveal a hidden prize underneath through touch/mouse interaction mapped via raycasting to UV coordinates. Scene code is generated by the Claude Agent SDK based on the game configuration.

## User Stories

### P1 (Critical)
- US1: As a player, I want to scratch the 3D card surface to reveal what's underneath so that I can discover my prize
- US2: As a player, I want realistic 3D scratch particle effects (metallic flakes falling off) so that the experience feels tactile
- US3: As a campaign creator, I want to configure the prize and reveal image so that the game matches my promotion

### P2 (Important)
- US4: As a player, I want the result to auto-reveal with a dramatic camera zoom and lighting change after scratching enough so that I don't have to scratch everything
- US5: As a campaign creator, I want to customize the scratch layer appearance (metallic foil, brand pattern texture) so that it matches my brand
- US6: As a player, I want audio feedback (scratch sound, reveal sound) so that the experience is immersive

### P3 (Nice to Have)
- US7: As a player, I want to see metallic scratch debris particles fall with gravity so that the 3D effect is realistic
- US8: As a campaign creator, I want multiple scratch zones with different prizes so that I can create more complex games

## Requirements

### 3D Scratch Mechanics
- REQ1: 3D card mesh with layered materials: metallic scratch layer on top, reveal layer underneath
- REQ2: Raycaster-based touch/mouse detection mapped to UV coordinates on the card surface
- REQ3: Custom fragment shader erases the scratch layer based on touch path (alpha mask updated via render-to-texture)
- REQ4: Brush size configurable in UV space (default equivalent to ~40px visual diameter)
- REQ5: Auto-reveal triggers when X% scratched (configurable, default: 60%)
- REQ6: Scratch percentage calculated via render target pixel sampling

### 3D Scene
- REQ7: THREE.Scene with PerspectiveCamera at a slight angle for 3D depth perception of the card
- REQ8: Spotlight on the card with ambient fill lighting
- REQ9: PBR materials: metallic/foil scratch layer (high metalness, low roughness), glossy reveal surface
- REQ10: 3D table/surface model beneath the card
- REQ11: Background environment via HDRI or color

### Visual Effects
- REQ12: 3D metallic flake particles falling off as user scratches (THREE.InstancedMesh or THREE.Points with gravity simulation)
- REQ13: Particle color and size match the scratch layer material
- REQ14: Auto-reveal animation: camera zoom + dramatic lighting change + 3D confetti celebration
- REQ15: Win celebration: 3D confetti particles, bloom post-processing, emissive glow on revealed prize
- REQ16: Lose effect: subtle depth-of-field blur, muted lighting

### Post-Processing
- REQ17: Bloom pass on reveal for luminous prize effect
- REQ18: Depth of field to focus on card surface during scratching
- REQ19: Anti-aliasing for smooth card edges

### Configuration Schema
```typescript
interface ScratchCardConfig {
  scratch_layer: ScratchLayerConfig;
  reveal_content: RevealContentConfig;
  auto_reveal_threshold: number;
  brush_size_uv: number;
  scene: SceneConfig;
  particle: ParticleConfig;
  post_processing: PostProcessingConfig;
}

interface ScratchLayerConfig {
  type: 'color' | 'gradient' | 'texture';
  color?: string;
  texture_slot?: string;
  metalness: number;
  roughness: number;
  pattern?: 'none' | 'dots' | 'lines';
}

interface RevealContentConfig {
  type: 'text' | 'image' | 'both';
  text?: string;
  image_slot?: string;
  is_winner: boolean;
  prize_code?: string;
}

interface SceneConfig {
  camera: CameraConfig;
  lighting: LightingConfig;
  background_color?: string;
  environment_map_slot?: string;
}

interface CameraConfig {
  fov: number;
  position: { x: number; y: number; z: number };
  look_at: { x: number; y: number; z: number };
  reveal_zoom_position: { x: number; y: number; z: number };
  reveal_zoom_duration_ms: number;
}

interface LightingConfig {
  ambient: { color: string; intensity: number };
  spotlight: { color: string; intensity: number; position: { x: number; y: number; z: number } };
  reveal_spotlight_intensity: number;
}

interface ParticleConfig {
  count: number;
  size: number;
  color: string;
  gravity: number;
  spread: number;
  lifetime_ms: number;
}

interface PostProcessingConfig {
  bloom_enabled: boolean;
  bloom_strength: number;
  bloom_threshold: number;
  dof_enabled: boolean;
  dof_focus: number;
  dof_aperture: number;
}
```

### Asset Slots
| Slot ID | Type | Required | Description |
|---------|------|----------|-------------|
| card_model | model_3d (GLB) | No | 3D card shape model (fallback: PlaneGeometry) |
| table_model | model_3d (GLB) | No | Table/surface model beneath the card |
| logo_model_3d | model_3d (GLB) | No | 3D brand logo placed in scene |
| scratch_texture | texture | No | Metallic foil / brand pattern for scratch layer |
| reveal_texture | texture | No | Prize image for reveal layer |
| environment_map | texture (HDR) | No | HDRI for reflections on metallic scratch surface |
| background_image | image | No | 2D fallback background |
| logo | image | No | 2D brand logo overlay |
| bgm_track | audio | No | Background music |
| scratch_sound | audio | No | Sound while scratching |
| reveal_sound | audio | Yes | Sound when prize revealed |
| win_sound | audio | No | Additional win celebration |

### Responsive Behavior
- REQ20: WebGL canvas fills viewport, renderer resizes on window change
- REQ21: Touch-optimized for finger scratching with raycaster UV mapping
- REQ22: Mouse cursor changes to scratch tool icon via CSS overlay

### Performance
- REQ23: Shader-based scratch (no per-pixel CPU calculation) for 60fps
- REQ24: Render-to-texture for scratch mask (offscreen render target)
- REQ25: Particle count capped at 500 for mobile performance
- REQ26: Compressed textures (KTX2) for scratch and reveal layers

### Outcome Handling
- REQ27: Emit `gameComplete` event when auto-reveal triggers
- REQ28: Event payload: `{ won: boolean, percentScratched: number, prize_code?: string }`
- REQ29: Display result overlay with CTA buttons (HTML overlay on 3D scene)

## Technical Implementation
- Framework: Three.js (WebGL renderer) with scene code generated by Claude Agent SDK
- Scratch: Custom ShaderMaterial with alpha mask texture updated via WebGLRenderTarget (render-to-texture)
- Interaction: THREE.Raycaster for UV-space touch mapping on card mesh surface
- Particles: THREE.InstancedMesh with per-instance transform and velocity for metallic scratch debris with gravity
- Materials: THREE.MeshStandardMaterial (scratch layer: high metalness; reveal layer: custom texture)
- Animation: GSAP for camera zoom on reveal, Three.js for particle physics
- Post-Processing: EffectComposer with UnrealBloomPass and BokehPass
- Audio: THREE.Audio for scratch and reveal sounds
- Percentage: Sample render target pixels to calculate scratched area percentage
- Asset Loading: GLTFLoader for GLB models, TextureLoader for images, RGBELoader for HDR

## Performance Targets
- Target: 60fps on mid-range mobile devices during active scratching
- Scratch shader: single draw call for the scratch layer
- Particle budget: 500 max concurrent particles
- Render target resolution: 512x512 for scratch mask (balance quality vs performance)
- GLB model size limit: 2MB per model asset
- Compressed textures (KTX2) for reduced GPU memory

## Dependencies
- Depends on: Template System (manifest, config injection, asset slots), Three.js runtime, Claude Agent SDK for code generation
- Required by: bundle_game_template skill when template_id = "scratch_card"

## Success Criteria
- [ ] Shader-based scratch layer reveals underlying content smoothly at 60fps
- [ ] Raycaster UV mapping works accurately for touch and mouse input
- [ ] Auto-reveal triggers at configured percentage threshold
- [ ] Metallic scratch debris particles render with gravity and look convincing
- [ ] Scratch effect works on touch devices without lag
- [ ] PBR metallic materials reflect environment map correctly
- [ ] Camera zoom and lighting change on reveal are dramatic and smooth
- [ ] Win celebration triggers bloom, confetti, and emissive glow
- [ ] Audio plays on user interaction (scratch start, reveal)
- [ ] Works offline after initial load
- [ ] Load time < 3s on 4G connection
