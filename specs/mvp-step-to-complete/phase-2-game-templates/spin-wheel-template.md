# Spin Wheel Game Template

## Purpose
A full 3D prize wheel rendered in Three.js with realistic physics-based spin, PBR materials, dynamic lighting, and cinematic camera animations. The wheel displays configurable segments with prizes/outcomes, spins with physically convincing deceleration in a WebGL scene, and reveals the result with post-processing celebration effects. Scene code is generated by the Claude Agent SDK based on the game configuration.

## User Stories

### P1 (Critical)
- US1: As a player, I want to tap/click to spin the 3D wheel so that I can participate in the game
- US2: As a player, I want to see the wheel spin in 3D with realistic physics and lighting so that the experience feels premium and exciting
- US3: As a campaign creator, I want to configure wheel segments (prizes, materials, probabilities) so that the game matches my promotion

### P2 (Important)
- US4: As a player, I want to see a 3D confetti particle explosion and bloom glow on the winning segment so that I know my result
- US5: As a campaign creator, I want to set spin duration, camera angles, and lighting mood so that I can control the visual tone
- US6: As a player, I want spatial audio feedback (spin sound, tick, win/lose) so that the 3D experience is immersive
- US7: As a player, I want the camera to zoom in on the winning segment when the wheel stops so that the reveal feels cinematic

### P3 (Nice to Have)
- US8: As a campaign creator, I want a "spin again" option for non-winning outcomes so that users stay engaged
- US9: As a player, I want haptic feedback on mobile when the wheel stops so that the result feels impactful
- US10: As a campaign creator, I want to upload a custom GLB wheel model so that the game uses my branded 3D asset

## Requirements

### 3D Wheel Mechanics
- REQ1: Wheel displays 4-12 segments as textured faces on a 3D cylinder/torus geometry with PBR materials
- REQ2: Spin triggered by tap/click on the 3D wheel (raycasted) or a dedicated "SPIN" button overlay
- REQ3: Wheel rotation uses physics-based angular deceleration via Three.js AnimationMixer combined with GSAP/Tween easing
- REQ4: Final position determined by weighted random selection of segments
- REQ5: 3D pointer/indicator model positioned above the wheel marks the winning segment

### 3D Scene Setup
- REQ6: THREE.Scene with PerspectiveCamera, configurable FOV and position
- REQ7: Lighting rig: ambient light for base illumination, directional light for primary shadows, point lights for dramatic segment highlights
- REQ8: PBR materials on each wheel segment with configurable metalness, roughness, and emissive properties
- REQ9: Environment map (HDR/EXR) for realistic reflections on metallic wheel surfaces
- REQ10: OrbitControls enabled in spectator mode, locked during spin animation

### Animation and Effects
- REQ11: Spin duration configurable (default: 5 seconds)
- REQ12: Minimum 3 full 3D rotations before stopping
- REQ13: Spatial tick sound (THREE.PositionalAudio) plays as each segment passes the pointer
- REQ14: Win animation: 3D confetti particle system (THREE.Points or InstancedMesh), bloom post-processing on winning segment, emissive glow pulse
- REQ15: Camera animation on win: smooth zoom and orbit toward the winning segment using GSAP timeline
- REQ16: Lose animation: subtle depth-of-field blur, muted lighting shift, consolation message overlay
- REQ17: Post-processing via Three.js EffectComposer: UnrealBloomPass for win celebration, BokehPass for depth of field

### Configuration Schema
```typescript
interface SpinWheelConfig {
  wheel_segments: WheelSegment[];
  spin_duration_ms: number;
  pointer_position: 'top' | 'right';
  allow_respin: boolean;
  scene: SceneConfig;
  camera: CameraConfig;
  lighting: LightingConfig;
  postprocessing: PostProcessingConfig;
}

interface WheelSegment {
  label: string;
  material: SegmentMaterial;
  icon_texture_index?: number;
  probability: number;
  is_winner: boolean;
  prize_code?: string;
}

interface SegmentMaterial {
  color: string;
  metalness: number;
  roughness: number;
  emissive?: string;
  emissive_intensity?: number;
}

interface SceneConfig {
  background_type: 'color' | 'environment_map' | 'skybox';
  background_color?: string;
  environment_map_slot?: string;
  fog_enabled: boolean;
  fog_color?: string;
  fog_near?: number;
  fog_far?: number;
}

interface CameraConfig {
  fov: number;
  position: { x: number; y: number; z: number };
  look_at: { x: number; y: number; z: number };
  win_zoom_position: { x: number; y: number; z: number };
  win_zoom_duration_ms: number;
}

interface LightingConfig {
  ambient: { color: string; intensity: number };
  directional: { color: string; intensity: number; position: { x: number; y: number; z: number } };
  point_lights: PointLightConfig[];
}

interface PointLightConfig {
  color: string;
  intensity: number;
  position: { x: number; y: number; z: number };
  distance: number;
  decay: number;
}

interface PostProcessingConfig {
  bloom_enabled: boolean;
  bloom_threshold: number;
  bloom_strength: number;
  bloom_radius: number;
  dof_enabled: boolean;
  dof_focus: number;
  dof_aperture: number;
  dof_max_blur: number;
}
```

### Asset Slots
| Slot ID | Type | Required | Description |
|---------|------|----------|-------------|
| wheel_model | model_3d (GLB) | No | Branded 3D wheel model, falls back to procedural geometry |
| pointer_model | model_3d (GLB) | No | 3D pointer/indicator, falls back to built-in arrow |
| logo_model_3d | model_3d (GLB) | No | 3D brand logo placed in scene |
| segment_textures | texture (atlas) | No | Texture atlas for segment icons |
| environment_map | texture (HDR/EXR) | No | HDRI environment map for reflections and skybox |
| background_image | image | No | 2D fallback background or UI overlay |
| logo | image | No | 2D brand logo overlay for HUD |
| bgm_track | audio | No | Background music loop |
| spin_sound | audio | No | Sound during spin |
| tick_sound | audio | No | Spatial sound as segments pass pointer |
| win_sound | audio | Yes | Celebration sound |
| lose_sound | audio | No | Consolation sound |

### Responsive Behavior
- REQ18: WebGL canvas fills the viewport, Three.js renderer resizes on window resize
- REQ19: Camera FOV and position adjust for portrait vs landscape orientation
- REQ20: Touch-friendly: raycasted tap targets on 3D wheel, 2D overlay buttons minimum 44px
- REQ21: LOD (Level of Detail) switching for mobile: reduced geometry complexity, lower resolution textures, disabled post-processing on low-end devices

### Outcome Handling
- REQ22: Emit `gameComplete` event with result: `{ won: boolean, segment: WheelSegment }`
- REQ23: Display result screen as HTML overlay on top of the 3D scene with prize details (if won) or consolation message
- REQ24: Optional CTA button ("Claim Prize", "Share", "Play Again")

## Technical Implementation
- Framework: Three.js (WebGL renderer via THREE.WebGLRenderer)
- Scene Graph: THREE.Scene with OrbitControls (locked during spin)
- Geometry: GLTFLoader for custom GLB wheel models, procedural CylinderGeometry/LatheGeometry as fallback
- Materials: THREE.MeshStandardMaterial with PBR properties (metalness, roughness, emissive, environment map)
- Animation: THREE.AnimationMixer for model animations, GSAP/Tween.js for spin easing and camera transitions
- Particles: THREE.Points with custom ShaderMaterial or THREE.InstancedMesh for 3D confetti
- Post-Processing: Three.js EffectComposer with UnrealBloomPass and BokehPass
- Audio: THREE.AudioListener + THREE.PositionalAudio for spatial sound, fallback to Web Audio API
- Touch: Three.js Raycaster for 3D interaction, Pointer Events API for 2D overlay
- Textures: KTX2 compressed textures via KTX2Loader for GPU-optimized delivery
- Code Generation: Claude Agent SDK generates the complete Three.js scene code from the game configuration

## Performance Targets
- Target: 60fps on mid-range mobile devices
- Draw calls: fewer than 50 per frame
- Total scene triangle count: fewer than 50k
- Texture memory budget: fewer than 32MB (compressed KTX2)
- GLB model size limit: 2MB per model asset
- LOD strategy: 3 levels (high/medium/low) selected based on device GPU tier
- Initial load: fewer than 3s on 4G connection (lazy-load non-critical assets after first render)

## Dependencies
- Depends on: Template System (manifest, config injection, asset slots), Three.js runtime, GLTFLoader, KTX2Loader
- Required by: bundle_game_template skill when template_id = "spin_wheel"

## Success Criteria
- [ ] 3D wheel renders in WebGL with all configured segments and PBR materials
- [ ] Spin animation is smooth (60fps on mid-range mobile, fewer than 50 draw calls)
- [ ] Winning segment matches weighted probability over 1000 spins (within 5% tolerance)
- [ ] Spatial audio plays correctly on mobile (after user interaction)
- [ ] Win outcome triggers bloom post-processing, 3D confetti particles, and camera zoom
- [ ] Lose outcome triggers depth-of-field blur and muted lighting
- [ ] GLB model loading works with fallback to procedural geometry when no model provided
- [ ] Environment map reflections visible on metallic wheel surfaces
- [ ] LOD switching activates on low-end devices without visual artifacts
- [ ] WebGL context loss handled gracefully with automatic recovery
- [ ] Works offline after initial load (all 3D assets cached)
